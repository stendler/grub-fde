# Creating a custom grub BOOTX64.EFI for the esp

This project should help creating a minimal efi grub executable as an initial bootloader to decrypt a luks partition and chainload the actual bootloader within the decrypted partition.
The generated efi executable replaces the BOOTX64.EFI in the esp (usually mounted in `/boot/efi`) generated by `grub-mkinstall`.

It embeds a custom grub.cfg generated from a template.

The primary use case is to **retry passwords for the cryptomount** without being dropped into the grub rescue shell or having to reboot via CTRL+ALT+DEL.

## How it works

`./configure` is used to determine the cryptodisk uuids and grub path to be embedded into the config (double checks the printed values!).
Create and soure a `.env` file with these values.

`./build` is using the values set in the environment to generate the grub.cfg from the template file.
It creates a memdisk tar file (by default compressed with xz) containing the generated grub.cfg and all grub modules specified in the environment.
and finally calls `grub-mkimage` to embed the memdisk, an `initial.cfg` and basic grub modules.

When booting the generated efi file, the `initial.cfg` is run, which decompresses and mounts the memdisk, inserts some basic modules required for scripting
and sources the embedded grub.cfg for the actual decryption and retry logic.

## Dependencies

Aside from `bash`, `sudo`, `df`, `sed`, `xz` and `tar`, `./configure` checks for needed commands and files:

- `grub` for the commands `grub-probe` and `grub-mkimage`
- `gettext` for the `envsubst` command
- `qemu-system-x86` for the `qemu-system-x86_64` command for testing purposes
  - `qemu-desktop` to get proper visual output
- `edk2-ovmf` for uefi firmware to test in qemu

## Usage

```sh
# to check dependencies and configure the .env file
./configure > .env
# to check if everything looks fine
cat .env
# to set the environment for the following commands
source .env

# to build the grub.cfg and embedd it into a BOOTX64.EFI file
./build
```

To test if the resulting file actually works, run `./test`.
It should open a qemu window and showing the usual password prompt.
Check with `<enter>`, that it asks again for your password without throwing you into a prompt.
After entering your password, it should show you the actual grub menu.
If it does, I would assume this test to work.
You could check the terminal (press `C`) and then `TAB` if all relevant commands are there (e.g. linux).

**This uses your actual encrypted drive. I'm not sure if it is safe to boot from that, so make sure to cancel by going to the terminal that invoked `./test` and running `Ctrl+C`!**

You can now copy the BOOTX64.EFI file into your esp partition. Make sure to make a backup of your previous file. 

## Troubleshooting

The grub modules defined in `build` are suitable for my setup. They may not be enough on your machine.
E.g. if you have the encrypted /boot on a btrfs or zfs filesystem, add those modules to the grub-mkimage command in `build` as well.


## ToDo

- add an `install` command to mount esp, backup the old efi file, copy the new one, and set `efibootmgr` ?
- detect needed filesystem modules automatically in configure and only load the necessary ones
